# jenkins/tasks/setup_wizard.yml
---
- name: Ensure Jenkins initialization scripts directory exists
  file:
    path: "{{ groovy_init_dir }}"
    state: directory
    owner: jenkins
    group: jenkins
    mode: 0775

- name: Disable Setup Wizard and Set Memory Size
  blockinfile:
    path: /etc/systemd/system/jenkins.service.d/override.conf
    block: |
      [Service]
      Environment="JAVA_OPTS=-Djenkins.install.runSetupWizard=false -Xms2g -Xmx2g"
    create: yes  # Create the file if it doesn't exist
    state: present
    mode: '0644'

- name: Retrieve login info from Secrets Manager
  set_fact:
    login_username: "{{ lookup('aws_secret', 'aline/tc/dev_pw.dev_login', nested=true) }}"
    login_password: "{{ lookup('aws_secret', 'aline/tc/dev_pw.dev_pw', nested=true) }}" 
    sonarqube_token: "{{ lookup('aws_secret', 'aline/tc/sonarqube_token.sonarqubeToken', nested=true) }}"
    gitlab_token: "{{ lookup('aws_secret', 'aline/tc/gitlab_api_token.gitlabApiToken', nested=true) }}"
    aws_secret_access_key: "{{ lookup('aws_secret', 'aline/tc/aws_credentials.awsSecretAccessKey', nested=true) }}"
    aws_access_key_id: "{{ lookup('aws_secret', 'aline/tc/aws_credentials.awsAccessKeyId', nested=true) }}"

  
- name: Debug all retrieved secrets
  debug:
    msg:
      - "Login Info: {{ login_username}} {{ login_password }}"
      - "AWS Credentials: {{ aws_access_key_id }} {{ aws_secret_access_key }}"
      - "GitLab API Token: {{ gitlab_token }}"
      - "Sonarqube API Token: {{ sonarqube_token }}"

- name: Create admin user 
  template:
    src: create_admin.groovy.j2
    dest: "{{ groovy_init_dir }}/create_admin.groovy"
    owner: jenkins
    group: jenkins
    mode: 0755
  vars:
    admin_username: "{{ login_username }}"
    admin_password: "{{ login_password }}"
  become: true

- name: Init Credentials
  template:
    src: init_credentials.groovy.j2
    dest: "{{ groovy_init_dir }}/init_credentials.groovy"
    owner: jenkins
    group: jenkins
    mode: 0755
  vars:
    sonarqube_api_token: "{{ sonarqube_token }}"
    aws_access_key_id: "{{ aws_access_key_id }}"
    aws_secret_access_key: "{{ aws_secret_access_key }}"
    gitlab_api_token: "{{ gitlab_token }}"
  become: true

- name: Create Pipelines for all components
  template:
    src: init_pipelines.groovy
    dest: "{{ groovy_init_dir }}/init_pipelines.groovy"
    owner: jenkins
    group: jenkins
    mode: 0755
  become: true

- name: Configure GitLab to push to Jenkins on change
  uri:
    url: "https://git1.smoothstack.com/api/v4/projects/{{ item.project_id }}/integrations/jenkins"
    method: PUT
    headers:
      PRIVATE-TOKEN: "{{ gitlab_token }}"
    body_format: form-urlencoded
    body:
      jenkins_url: "{{ base_url }}"
      project_name: "{{ item.project_name }}"
      username: "{{ login_username }}"
      password: "{{ login_password }}"
      notify_commit: "true"
    status_code: 200
    follow_redirects: all
  with_items: "{{ repositories }}"


- name: Restart Jenkins & Reload Daemon
  systemd:
    name: jenkins
    state: restarted
    daemon_reload: yes
  become: true

- name: Wait for Jenkins port to be ready
  wait_for:
    port: 8080
    delay: 10
    timeout: 60

